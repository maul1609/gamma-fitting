calcFlag=true;
fittingFlag=true;
analysisFlag=false;
%project='vocals';

switch project
    case 'dcmex'
    path='/home/bowen/DC-Mex/FAAM/';
    files={'core-cloud-phy_faam_20220719_v602_r1_c298.nc',...
        'core-cloud-phy_faam_20220720_v602_r1_c299.nc',...
        'core-cloud-phy_faam_20220722_v602_r1_c300.nc',...
        'core-cloud-phy_faam_20220723_v602_r1_c301.nc',...
        'core-cloud-phy_faam_20220724_v602_r1_c302.nc',...
        'core-cloud-phy_faam_20220725_v602_r1_c303.nc',...
        'core-cloud-phy_faam_20220726_v602_r1_c304.nc',...
        'core-cloud-phy_faam_20220727_v602_r1_c305.nc',...
        'core-cloud-phy_faam_20220729_v602_r1_c306.nc',...
        'core-cloud-phy_faam_20220730_v602_r1_c307.nc',...
        'core-cloud-phy_faam_20220731_v602_r1_c308.nc',...
        'core-cloud-phy_faam_20220801_v602_r1_c309.nc',...
        'core-cloud-phy_faam_20220802_v602_r1_c310.nc',...
        'core-cloud-phy_faam_20220803_v602_r1_c311.nc',...
        'core-cloud-phy_faam_20220804_v602_r1_c312.nc',...
        'core-cloud-phy_faam_20220806_v602_r1_c313.nc',...
        'core-cloud-phy_faam_20220807_v602_r1_c314.nc'};
    
    files1={'core_faam_20220719_v005_r0_c298.nc',...
        'core_faam_20220720_v005_r0_c299.nc',...
        'core_faam_20220722_v005_r0_c300.nc',...
        'core_faam_20220723_v005_r0_c301.nc',...
        'core_faam_20220724_v005_r0_c302.nc',...
        'core_faam_20220725_v005_r0_c303.nc',...
        'core_faam_20220726_v005_r0_c304.nc',...
        'core_faam_20220727_v005_r0_c305.nc',...
        'core_faam_20220729_v005_r0_c306.nc',...
        'core_faam_20220730_v005_r0_c307.nc',...
        'core_faam_20220731_v005_r0_c308.nc',...
        'core_faam_20220801_v005_r0_c309.nc',...
        'core_faam_20220802_v005_r0_c310.nc',...
        'core_faam_20220803_v005_r0_c311.nc',...
        'core_faam_20220804_v005_r0_c312.nc',...
        'core_faam_20220806_v005_r0_c313.nc',...
        'core_faam_20220807_v005_r0_c314.nc'};
    case 'mphase'
    path='/home/bowen/MPHASE/';
    files={'core-cloud-phy_faam_20220927_v601_r0_c318.nc', ...
        'core-cloud-phy_faam_20221018_v601_r0_c319.nc', ...
        'core-cloud-phy_faam_20221021_v601_r0_c320.nc', ...
        'core-cloud-phy_faam_20221023_v601_r0_c321.nc', ...
        'core-cloud-phy_faam_20221024_v601_r0_c322.nc', ...
        'core-cloud-phy_faam_20221024_v601_r0_c323.nc', ...
        'core-cloud-phy_faam_20221025_v601_r0_c324.nc', ...
        'core-cloud-phy_faam_20221028_v601_r0_c325.nc', ...
        'core-cloud-phy_faam_20221028_v601_r0_c326.nc', ...
        'core-cloud-phy_faam_20221029_v601_r0_c327.nc', ...
        'core-cloud-phy_faam_20221031_v601_r0_c328.nc', ...
        'core-cloud-phy_faam_20221101_v601_r0_c329.nc', ...
        'core-cloud-phy_faam_20221103_v601_r0_c330.nc', ...
        'core-cloud-phy_faam_20221103_v601_r0_c331.nc', ...
        'core-cloud-phy_faam_20221104_v601_r0_c332.nc', ...
        'core-cloud-phy_faam_20221105_v601_r0_c333.nc'};
    
    files1={'core_faam_20220927_v005_r0_c318.nc', ...
        'core_faam_20221018_v005_r0_c319.nc', ...
        'core_faam_20221021_v005_r0_c320.nc', ...
        'core_faam_20221023_v005_r0_c321.nc', ...
        'core_faam_20221024_v005_r0_c322.nc', ...
        'core_faam_20221024_v005_r0_c323.nc', ...
        'core_faam_20221025_v005_r0_c324.nc', ...
        'core_faam_20221028_v005_r0_c325.nc', ...
        'core_faam_20221028_v005_r0_c326.nc', ...
        'core_faam_20221029_v005_r0_c327.nc', ...
        'core_faam_20221031_v005_r0_c328.nc', ...
        'core_faam_20221101_v005_r0_c329.nc', ...
        'core_faam_20221103_v005_r0_c330.nc', ...
        'core_faam_20221103_v005_r0_c331.nc', ...
        'core_faam_20221104_v005_r0_c332.nc', ...
        'core_faam_20221105_v005_r0_c333.nc'};
    case 'vocals'
    path='/home/bowen/VOCALS/';
    files={'core-cloud-phy_faam_20081029_v500_r0_b410.nc', ...
        'core-cloud-phy_faam_20081030_v500_r0_b411.nc', ...
        'core-cloud-phy_faam_20081031_v500_r0_b412.nc', ...
        'core-cloud-phy_faam_20081103_v500_r1_b413.nc', ...
        'core-cloud-phy_faam_20081104_v500_r1_b414.nc', ...
        'core-cloud-phy_faam_20081105_v500_r1_b415.nc', ...
        'core-cloud-phy_faam_20081107_v500_r1_b416.nc', ...
        'core-cloud-phy_faam_20081110_v500_r1_b418.nc', ...
        'core-cloud-phy_faam_20081112_v500_r1_b419.nc'};
    
    files1={'core_faam_20081029_v004_r6_b410.nc', ...
        'core_faam_20081030_v004_r6_b411.nc', ...
        'core_faam_20081031_v004_r6_b412.nc', ...
        'core_faam_20081103_v004_r6_b413.nc', ...
        'core_faam_20081104_v004_r6_b414.nc', ...
        'core_faam_20081105_v004_r6_b415.nc', ...
        'core_faam_20081107_v004_r6_b416.nc', ...
        'core_faam_20081110_v004_r6_b418.nc', ...
        'core_faam_20081112_v004_r6_b419.nc'};
    otherwise 
        disp('WARNING! Project not defined');
end
Zatm=2000:100:8000;
T_base=[0.3,1.5,2.7,5.1,5.4,7.6,7.1,6.6,...
    6.0,7.4,2.8,5.3,5.0,6.3,4.6,5.2,2.8]+273.15;
P_base=zeros(size(T_base));
z_base=zeros(size(T_base));
thisOne=1;

if calcFlag
    for thisOne=1:length(files)
        if strcmp(project,'vocals')
            timeCDP=ncread([path,files{thisOne}],'Time');
        else
            timeCDP=ncread([path,files{thisOne}],'time');
        end
        if strcmp(project,'dcmex')
            concCDP=squeeze(nanmean(ncread([path,files{thisOne}],'cdp/cdp_conc_psd'),2));
            lwcCDP=squeeze(nanmean(ncread([path,files{thisOne}],'cdp/cdp_lwc'),1))';
            dcentreCDP=ncread([path,files{thisOne}],'cdp/cdp_bin_centre');
            dwidthCDP=ncread([path,files{thisOne}],'cdp/cdp_bin_width');
        elseif strcmp(project,'mphase')
            concCDP=double(squeeze(ncread([path,files{thisOne}],'cdp/cdp_conc_psd'))./1000);
            lwcCDP=squeeze(ncread([path,files{thisOne}],'cdp/cdp_lwc'))';
            dcentreCDP=double(ncread([path,files{thisOne}],'cdp/cdp_bin_centre'));
            dwidthCDP=double(ncread([path,files{thisOne}],'cdp/cdp_bin_width'));
        elseif strcmp(project,'vocals')
            concCDP=zeros(length(timeCDP),30);
            for i=1:30
                concCDP(:,i)=ncread([path,files{thisOne}],['CDP_',num2str(i,'%02d')]);
            end
            dcentreCDP=double(0.5.*(ncread([path,files{thisOne}],'CDP_D_L_NOM')+ncread([path,files{thisOne}],'CDP_D_U_NOM')));

            dwidthCDP=double((ncread([path,files{thisOne}],'CDP_D_U_NOM')-ncread([path,files{thisOne}],'CDP_D_L_NOM')));
            lwcCDP=nansum(concCDP.*1e6.*repmat((dcentreCDP./1e6).^3,[1 length(timeCDP)])',2).*1000000;
            concCDP=double(concCDP');
        end

        
        ALT_GIN=nanmean(ncread([path,files1{thisOne}],'ALT_GIN'),1)';
        TAT_DI=nanmean(ncread([path,files1{thisOne}],'TAT_DI_R'),1)';
        PS_RVSM=nanmean(ncread([path,files1{thisOne}],'PS_RVSM'),1)'.*100;
        ind=find(isfinite(ALT_GIN) & isfinite(TAT_DI) & isfinite(PS_RVSM) & ...
            (abs(TAT_DI-T_base(thisOne))<5 ) );
        P=polyfit(TAT_DI(ind),ALT_GIN(ind),2);
        z_base(thisOne)=polyval(P,T_base(thisOne));
        P=polyfit(TAT_DI(ind),PS_RVSM(ind),2);
        P_base(thisOne)=polyval(P,T_base(thisOne));

        LWC_adiabatic=calc_adiabatic_lwc(T_base(thisOne),...
            P_base(thisOne),z_base(thisOne),PS_RVSM,ALT_GIN);


        indAA=find(~isnan(sum(concCDP,1)) & (sum(concCDP,1)>5));
        now_data_DP=concCDP(:,indAA)';
        now_total_Nd=nansum(now_data_DP,2);
        d_size=dcentreCDP';
        %pcolor(timeCDP,dcentreCDP,real(log10(concCDP)));shading flat
        bimodal_fitting;


    
        fit_data(thisOne).beta1=beta1;
        fit_data(thisOne).F1=F1;
        fit_data(thisOne).M0=M0;
        fit_data(thisOne).M2=M2;
        fit_data(thisOne).M3=M3;
        fit_data(thisOne).betat=betat;
        fit_data(thisOne).dispdat=dispdat;
        fit_data(thisOne).LWC_adiabatic=LWC_adiabatic(indAA);
        fit_data(thisOne).LWC=lwcCDP(indAA);
        if fittingFlag
            fit_data(thisOne).D1=D1;
            fit_data(thisOne).D2=D2;
            fit_data(thisOne).Dav=Dav;
            fit_data(thisOne).lam1=lam1;
            fit_data(thisOne).lam2=lam2;
            fit_data(thisOne).mu1=mu1;
            fit_data(thisOne).mu2=mu2;
            fit_data(thisOne).n01=n01;
            fit_data(thisOne).n02=n02;
            fit_data(thisOne).disptot=disptot;
            fit_data(thisOne).M0_1=M0_1;
            fit_data(thisOne).M0_2=M0_2;
            fit_data(thisOne).M2_1=M2_1;
            fit_data(thisOne).M2_2=M2_2;
            fit_data(thisOne).M3_1=M3_1;
            fit_data(thisOne).M3_2=M3_2;
            fit_data(thisOne).PSD=PSD;
            fit_data(thisOne).PSDcalc1=PSDcalc1;
            fit_data(thisOne).PSDcalc2=PSDcalc2;
            fit_data(thisOne).PSDcalc=PSDcalc;
            fit_data(thisOne).concCDP=concCDP(:,indAA);
            fit_data(thisOne).timeCDP=timeCDP(indAA);
            fit_data(thisOne).dcentreCDP=dcentreCDP;
        end    
    end
end

if analysisFlag
    figure
    t=tiledlayout('flow');
    for i=1:length(files)
        disp(files{i});
        nexttile, scatter(fit_data(i).M0,fit_data(i).beta1,20,fit_data(i).F1,'filled');
        ylim([1.0,1.5]);
        clim([0.1 0.9])
        xlim([0,4e-6])
        xlim([0,1000e6])
        str1=replace(files{i},'core-cloud-phy_faam_','');
        str1=replace(str1,'_v602_r1_',' ');
        str1=replace(str1,'_v601_r0_',' ');
        str1=replace(str1,'_v500_r0_',' ');
        str1=replace(str1,'_v500_r1_',' ');
        str1=replace(str1,'.nc','');
        text(0.1,0.8,str1,'units','normalized')
    end
    xlabel(t,'M3');ylabel(t,'\beta');
    cb=colorbar;
    cb.Layout.Tile='east';
    ylabel(cb,'$F=\frac{M2^3}{M3^3M0}$','interpreter','latex')
end

function LWC_adiabatic=calc_adiabatic_lwc(T_base,P_base,z_base,P,z_obs)

% === Constants ===
Lv = 2.5e6;             % Latent heat of vaporization (J/kg)
Rv = 461;               % Gas constant for water vapor (J/kg/K)
cp = 1005;              % Specific heat of air at constant pressure (J/kg/K)
g = 9.81;               % Gravitational acceleration (m/s^2)

% === Step 1: Estimate Temperature at Observation Height ===
lapse_rate = 0.0065;    % Standard lapse rate (K/m)
T = T_base - lapse_rate .* (z_obs - z_base);  % Temperature at observation height (K)

% === Step 2: Compute Saturation Mixing Ratio (qs) at that temperature and pressure ===
% Saturation vapor pressure over water (Tetens formula)
es_base = 6.112 .* exp((17.67 .* (T_base - 273.15)) ./ (T_base - 29.65));  % in hPa
es_base = es_base .* 100;  % convert to Pa

es = 6.112 .* exp((17.67 .* (T - 273.15)) ./ (T - 29.65));  % in hPa
es = es .* 100;  % convert to Pa

qs_base = 0.622 .* es_base ./ (P_base - es_base);  % dimensionless (kg/kg)
qs = 0.622 .* es ./ (P - es);  % dimensionless (kg/kg)


LWC_adiabatic = max((qs_base-qs).*P./Rv./T.*1000,0);   % g/m^3

end
