figure

project='dcmex';

switch project
    case 'vocals'
        load vocals.mat
        path='/home/bowen/VOCALS/';
        files={'core-cloud-phy_faam_20081029_v500_r0_b410.nc', ...
            'core-cloud-phy_faam_20081030_v500_r0_b411.nc', ...
            'core-cloud-phy_faam_20081031_v500_r0_b412.nc', ...
            'core-cloud-phy_faam_20081103_v500_r1_b413.nc', ...
            'core-cloud-phy_faam_20081104_v500_r1_b414.nc', ...
            'core-cloud-phy_faam_20081105_v500_r1_b415.nc', ...
            'core-cloud-phy_faam_20081107_v500_r1_b416.nc', ...
            'core-cloud-phy_faam_20081110_v500_r1_b418.nc', ...
            'core-cloud-phy_faam_20081112_v500_r1_b419.nc'};
        
        files1={'core_faam_20081029_v004_r6_b410.nc', ...
            'core_faam_20081030_v004_r6_b411.nc', ...
            'core_faam_20081031_v004_r6_b412.nc', ...
            'core_faam_20081103_v004_r6_b413.nc', ...
            'core_faam_20081104_v004_r6_b414.nc', ...
            'core_faam_20081105_v004_r6_b415.nc', ...
            'core_faam_20081107_v004_r6_b416.nc', ...
            'core_faam_20081110_v004_r6_b418.nc', ...
            'core_faam_20081112_v004_r6_b419.nc'};
        titlestring='VOCALS';
    case 'mphase'
        load mphase.mat
        path='/home/bowen/MPHASE/';
        files={'core-cloud-phy_faam_20220927_v601_r0_c318.nc', ...
            'core-cloud-phy_faam_20221018_v601_r0_c319.nc', ...
            'core-cloud-phy_faam_20221021_v601_r0_c320.nc', ...
            'core-cloud-phy_faam_20221023_v601_r0_c321.nc', ...
            'core-cloud-phy_faam_20221024_v601_r0_c322.nc', ...
            'core-cloud-phy_faam_20221024_v601_r0_c323.nc', ...
            'core-cloud-phy_faam_20221025_v601_r0_c324.nc', ...
            'core-cloud-phy_faam_20221028_v601_r0_c325.nc', ...
            'core-cloud-phy_faam_20221028_v601_r0_c326.nc', ...
            'core-cloud-phy_faam_20221029_v601_r0_c327.nc', ...
            'core-cloud-phy_faam_20221031_v601_r0_c328.nc', ...
            'core-cloud-phy_faam_20221101_v601_r0_c329.nc', ...
            'core-cloud-phy_faam_20221103_v601_r0_c330.nc', ...
            'core-cloud-phy_faam_20221103_v601_r0_c331.nc', ...
            'core-cloud-phy_faam_20221104_v601_r0_c332.nc', ...
            'core-cloud-phy_faam_20221105_v601_r0_c333.nc'};
        
        files1={'core_faam_20220927_v005_r0_c318.nc', ...
            'core_faam_20221018_v005_r0_c319.nc', ...
            'core_faam_20221021_v005_r0_c320.nc', ...
            'core_faam_20221023_v005_r0_c321.nc', ...
            'core_faam_20221024_v005_r0_c322.nc', ...
            'core_faam_20221024_v005_r0_c323.nc', ...
            'core_faam_20221025_v005_r0_c324.nc', ...
            'core_faam_20221028_v005_r0_c325.nc', ...
            'core_faam_20221028_v005_r0_c326.nc', ...
            'core_faam_20221029_v005_r0_c327.nc', ...
            'core_faam_20221031_v005_r0_c328.nc', ...
            'core_faam_20221101_v005_r0_c329.nc', ...
            'core_faam_20221103_v005_r0_c330.nc', ...
            'core_faam_20221103_v005_r0_c331.nc', ...
            'core_faam_20221104_v005_r0_c332.nc', ...
            'core_faam_20221105_v005_r0_c333.nc'};
        titlestring='MPHASE';
    case 'dcmex'
        load dcmex.mat
        path='/home/bowen/DC-Mex/FAAM/';
        files={'core-cloud-phy_faam_20220719_v602_r1_c298.nc',...
            'core-cloud-phy_faam_20220720_v602_r1_c299.nc',...
            'core-cloud-phy_faam_20220722_v602_r1_c300.nc',...
            'core-cloud-phy_faam_20220723_v602_r1_c301.nc',...
            'core-cloud-phy_faam_20220724_v602_r1_c302.nc',...
            'core-cloud-phy_faam_20220725_v602_r1_c303.nc',...
            'core-cloud-phy_faam_20220726_v602_r1_c304.nc',...
            'core-cloud-phy_faam_20220727_v602_r1_c305.nc',...
            'core-cloud-phy_faam_20220729_v602_r1_c306.nc',...
            'core-cloud-phy_faam_20220730_v602_r1_c307.nc',...
            'core-cloud-phy_faam_20220731_v602_r1_c308.nc',...
            'core-cloud-phy_faam_20220801_v602_r1_c309.nc',...
            'core-cloud-phy_faam_20220802_v602_r1_c310.nc',...
            'core-cloud-phy_faam_20220803_v602_r1_c311.nc',...
            'core-cloud-phy_faam_20220804_v602_r1_c312.nc',...
            'core-cloud-phy_faam_20220806_v602_r1_c313.nc',...
            'core-cloud-phy_faam_20220807_v602_r1_c314.nc'};
        
        files1={'core_faam_20220719_v005_r0_c298.nc',...
            'core_faam_20220720_v005_r0_c299.nc',...
            'core_faam_20220722_v005_r0_c300.nc',...
            'core_faam_20220723_v005_r0_c301.nc',...
            'core_faam_20220724_v005_r0_c302.nc',...
            'core_faam_20220725_v005_r0_c303.nc',...
            'core_faam_20220726_v005_r0_c304.nc',...
            'core_faam_20220727_v005_r0_c305.nc',...
            'core_faam_20220729_v005_r0_c306.nc',...
            'core_faam_20220730_v005_r0_c307.nc',...
            'core_faam_20220731_v005_r0_c308.nc',...
            'core_faam_20220801_v005_r0_c309.nc',...
            'core_faam_20220802_v005_r0_c310.nc',...
            'core_faam_20220803_v005_r0_c311.nc',...
            'core_faam_20220804_v005_r0_c312.nc',...
            'core_faam_20220806_v005_r0_c313.nc',...
            'core_faam_20220807_v005_r0_c314.nc'};
        titlestring='DCMEX';
    otherwise
        disp('no project with this name defined')
        quit
end

num=length(fit_data);

numx=floor(sqrt(num));
numy=ceil(num/numx);

t=tiledlayout(numx,numy,'padding','none','tilespacing','compact') 

for i=1:num
    time=ncread([path,files1{i}],'Time');
    temp=ncread([path,files1{i}],'TAT_DI_R');
    nexttile

    tempDisp=interp1(time,nanmean(temp,1)-273.15,double(fit_data(i).timeCDP));

    Ddat=sum(fit_data(i).PSD.*repmat(fit_data(i).dcentreCDP'./1e6,[length(fit_data(i).timeCDP),1]),2)./ ...
        sum(fit_data(i).PSD,2);


    plot(fit_data(i).M3_1/fit_data(i).M3,tempDisp,'.')
    % ind=find( (fit_data(i).D1>1e-6));
    % plot(fit_data(i).M3(ind),tempDisp(ind),'.');hold on;
    % ind=find( (abs(fit_data(i).D1-fit_data(i).D2)>8e-6) & (fit_data(i).M0_1>5e6) & (fit_data(i).M0_2>5e6) & (fit_data(i).D1>1e-6));
    % plot(fit_data(i).M3(ind),tempDisp(ind),'.');hold on;
    
    % [med, centers, lower_err, upper_err]=calcErrorBars(tempDisp,fit_data(i).dispdat.*Ddat);
    % errorbar(med, centers, lower_err, upper_err, 'horizontal', 'o', ...
    %     'CapSize', 5, 'MarkerSize', 6, 'LineWidth', 1.2);hold on;
    % [med, centers, lower_err, upper_err]=calcErrorBars(tempDisp,Ddat);
    % errorbar(med, centers, lower_err, upper_err, 'horizontal', 'o', ...
    %     'CapSize', 5, 'MarkerSize', 6, 'LineWidth', 1.2);hold on;

    hold on;ylim([-30,10]);
    set(gca,'YDir','reverse')
    xlim([0 1])
    text(0.1,0.9,strrep(strrep(files1{i},'core_faam_',''),'_',' '),'units','normalized')
end
title(t,titlestring)
xlabel(t,'M3')
ylabel(t,'T (\circ C)')


function [med, centers, lower_err, upper_err]=calcErrorBars(T,N)

% Bin temperature into 2.5Â°C intervals
binWidth = 2;
edges = min(T):binWidth:max(T);
centers = edges(1:end-1) + binWidth/2;

% Initialize
med = NaN(size(centers));
q25 = NaN(size(centers));
q75 = NaN(size(centers));

% Compute statistics per bin
for i = 1:length(centers)
    inBin = T >= edges(i) & T < edges(i+1);
    if any(inBin)
        data = N(inBin);
        med(i) = median(data);
        q25(i) = quantile(data, 0.25);
        q75(i) = quantile(data, 0.75);
    end
end

% Error bars: horizontal
lower_err = med - q25;
upper_err = q75 - med;

end